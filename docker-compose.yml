version: "3"
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/var/www/html
    ports:
      - 8000:80
    depends_on:
      - db
    networks:
      - cake
    environment:
      DOCKER_OS_NAME: linux
      DOCKER_PHP_VERSION: ${_PHP}
      DB: Mysql
      # a host alias or IP address
      MYSQL_SERVICE_HOST: db
      MYSQL_SERVICE_PORT: 3306
      TEST_MYSQL_SERVICE_HOST: db
      TEST_MYSQL_SERVICE_PORT: 3306
      DATABASE_NAME: phpcms
      DATABASE_SERVICE_NAME: MYSQL
      #(optional)
      #WEBHOOK_URL: <discordapp-url>
      # Persistent connection credentials
      DATABASE_USER: root
      # overrides docker-compose-alias.sh -p=<password>
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      # Just add TEST_DATABASE_USER and TEST_DATABASE_PASSWORD
      TEST_DATABASE_USER: ubuntu
      # overrides docker-compose-alias.sh -t=<password>
      #TEST_DATABASE_PASSWORD: <test-password>
      # CakePHP generated
      #CAKEPHP_SECRET_TOKEN: <secret-token>
      #CAKEPHP_SECRET_SALT: <secret-salt>
      #CAKEPHP_SECURITY_CIPHER_SEED: <cipher-seed>
      # Generated by ./configure.sh -h
      GET_HASH_PASSWORD: ${GET_HASH_PASSWORD}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"] 
      interval: 1m30s
      timeout: 10s 
      retries: 3 
      # v3.4 compose file
      #start_period: 40s
    dns:
      - 8.8.8.8
      - 8.8.4.4
  db:
    image: library/mariadb:10.4-bionic
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - cake
    environment:
      MYSQL_DATABASE: ${DATABASE_NAME}
      MYSQL_ROOT_PASSWORD: ${DATABASE_PASSWORD}
      MYSQL_USER: ubuntu
      MYSQL_PASSWORD: ${TEST_DATABASE_PASSWORD}
    dns:
      - 8.8.8.8
      - 8.8.4.4
volumes:
  db-data:
    external: false

networks:
  cake:
    external: false

