version: "2.1"
services:
  cakephp:
    build:
      context: .
      dockerfile: dockerfile
      args:
        # variables are build-time environment
        - PHP_TAG
        - PHP_OWNER
        - DB
        - MYSQL_SERVICE_HOST
        - MYSQL_SERVICE_PORT
        - TEST_MYSQL_SERVICE_HOST
        - TEST_MYSQL_SERVICE_PORT
        - DATABASE_SERVICE_NAME
        #(optional)
        #- WEBHOOK_URL=<discordapp-url>
        # Persistent connection credentials
        - DATABASE_NAME
        - DATABASE_USER
        - DATABASE_PASSWORD
        - TEST_DATABASE_USER
        - TEST_DATABASE_PASSWORD
        # CakePHP generated
        #- CAKEPHP_SECRET_TOKEN
        #- CAKEPHP_SECRET_SALT
        #- CAKEPHP_SECURITY_CIPHER_SEED
        - SERVER_NAME
    volumes:
      - data:/var/www/html
    ports:
      # CakePHPs now listening on port 80 (through apache2), forward 8000
      - 8000:80
    depends_on:
      - db
    networks:
      - cake
  #docker-compose v3
    #healthcheck:
      #test: ["CMD", "curl", "-f", "http://localhost"]
      #interval: 1m30s
      #timeout: 10s
      #retries: 3
      # v3.4 compose file
      #start_period: 40s
  db:
    # undefined image:tag syntax !! Using "sed -E" to change tag
    #image: linuxserver/mariadb:arm32v7-latest
    image: linuxserver/mariadb:arm32v7-latest
    volumes:
      - db-data:/config
    ports:
      - 3306:3306
    restart: unless-stopped
    networks:
      - cake
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
      - MYSQL_DATABASE=${DATABASE_NAME?database-name-missing}
      - MYSQL_ROOT_PASSWORD=${DATABASE_PASSWORD?sql-root-database-password-missing}
      - MYSQL_USER=${TEST_DATABASE_USER?test-database-user-missing}
      - MYSQL_PASSWORD=${TEST_DATABASE_PASSWORD?test-database-password-missing}
  bluetooth-audio:
    network_mode: host
    restart: always
    build:
      context: ./balena-sound/bluetooth-audio
      dockerfile: Dockerfile.raspberrypi3
    privileged: true
    labels:
      io.balena.features.dbus: 1
      io.balena.features.supervisor-api: 1
volumes:
  data:
    external: false
  db-data:
    external: false
networks:
  cake:
    external: false
