version: "2.1"
services:
  cakephp:
    build:
      context: .
      dockerfile: Dockerfile      
    volumes:
      - data:/var/www/html
    ports:
      - 8000:80
    depends_on:
      - db
    networks:
      - cake
    environment:
      - DOCKER_OS_NAME=linux
      - DOCKER_PHP_VERSION=7.2
      - DB=Mysql
      # a host alias or IP address
      - MYSQL_SERVICE_HOST=db
      - MYSQL_SERVICE_PORT=3306
      - TEST_MYSQL_SERVICE_HOST=db
      - TEST_MYSQL_SERVICE_PORT=3306
      - DATABASE_SERVICE_NAME=MYSQL
      #(optional)
      #- WEBHOOK_URL=<discordapp-url>
      # Persistent connection credentials
      - DATABASE_NAME
      - DATABASE_USER=root
      - DATABASE_PASSWORD
      - TEST_DATABASE_USER
      - TEST_DATABASE_PASSWORD
      # CakePHP generated
      #- CAKEPHP_SECRET_TOKEN=<secret-token>
      #- CAKEPHP_SECRET_SALT=<secret-salt>
      #- CAKEPHP_SECURITY_CIPHER_SEED=<cipher-seed>
# docker-compose v3
#    healthcheck:
 #     test: ["CMD", "curl", "-f", "http://localhost"] 
   #   interval: 1m30s
  #    timeout: 10s 
    #  retries: 3 
      # v3.4 compose file
      #start_period: 40s
  db:
    image: linuxserver/mariadb:arm32v7-latest
    volumes:
      - db-data:/config
    ports:
      - 3306:3306
    restart: unless-stopped
    networks:
      - cake
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
      - MYSQL_DATABASE=${DATABASE_NAME?database-name-missing}
      - MYSQL_ROOT_PASSWORD=${DATABASE_PASSWORD?sql-root-database-password-missing}
      - MYSQL_USER=${TEST_DATABASE_USER?test-database-user-missing}
      - MYSQL_PASSWORD=${TEST_DATABASE_PASSWORD?test-database-password-missing}
  bluetooth-audio:
    network_mode: host
    restart: always
    build: ./balena-sound/bluetooth-audio
    privileged: true
    labels:
      io.balena.features.dbus: 1
      io.balena.features.supervisor-api: 1
volumes:
  data:
    external: false
  db-data:
    external: false
networks:
  cake:
    external: false

