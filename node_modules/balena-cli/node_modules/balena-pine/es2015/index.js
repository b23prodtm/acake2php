"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BalenaPine = void 0;
const tslib_1 = require("tslib");
const url = require("url");
const errors = require("balena-errors");
const pinejs_client_core_1 = require("pinejs-client-core");
class BalenaPine extends pinejs_client_core_1.PinejsClientCore {
    constructor(params, backendParams) {
        super(Object.assign(Object.assign({}, params), { apiPrefix: url.resolve(backendParams.apiUrl, `/${backendParams.apiVersion}/`) }));
        this.backendParams = backendParams;
        this.backendParams = backendParams;
        this.API_URL = backendParams.apiUrl;
        this.API_VERSION = backendParams.apiVersion;
    }
    _request(options) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const { apiKey, apiUrl, auth, request } = this.backendParams;
            const hasKey = yield auth.hasKey();
            const authenticated = hasKey || (apiKey != null && apiKey.length > 0);
            options = Object.assign({ apiKey, baseUrl: apiUrl, sendToken: authenticated && !options.anonymous }, options);
            try {
                const { body } = yield request.send(options);
                return body;
            }
            catch (err) {
                if (err.statusCode !== 401) {
                    throw err;
                }
                if (options.anonymous) {
                    throw err;
                }
                if (!authenticated) {
                    throw new errors.BalenaNotLoggedIn();
                }
                throw err;
            }
        });
    }
}
exports.BalenaPine = BalenaPine;
//# sourceMappingURL=index.js.map