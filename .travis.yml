cache:
  directories:
    - app/tmp/cache
    - .autoconf
    - $HOME/.composer/cache/files
env:
  matrix:
    - DB=mysql
  global:
    - PHPUNIT=4
    - PHPCS=3
    - COLLECT_COVERAGE=true
    # The next declaration is the encrypted OC_SECRET, created
    # via the "travis encrypt" command using the project repo's public key
    - secure:  "O+HejqZgXZFf0eD3GdvUwL2dsJsW+5biztfWYKHNfzv5u9j6Nn8JSoLdIp+Bg6Kct6kCJebM7oWHCh1fhyEm3AluusmqKHN8VKwQuINEZKAxPRFGl3NKkEU/Y95tHR3JIubZbZ0oZYmnl7z+YgVvM4LvmfvAwdpXzRt4SWOzGRWiL8uRaovOwW10HUB6qcO70Rn9XIHz4gUAoAEWQgSlJ4aNftu/lpuYs4P1r0+6fI/nfRRBMOogBQLEMqw6enPP+RrWx2pLwuxaQqChtk2td5PJdLiifW7C8SiAsljSgIRiaytAOgIs5KJsLGUdAPNXIMqUYFJ776J3L+ln8/nM/H8ARGB2P3smY5HM34/NrzUat2X/B6Uqg1F0Fs/794aomhaeqgh4b2MRI5srjQ/grNK61H1AftdR6JSLVjm6AUg743GQJF7sgNfK60n28EEZApAEzDS0v1PyU7U/HAZIalqWnttO0ycQyj2rf1XC++6BuTcRdmxx4dZoqZIn7xHzBQvi99ljv4JuwUgrNYXvcSEkXu6Y5GqMl2rtjxrdaGATpePuk1ju1kfB/7fQsR3ZZOaxULOSlQRcArsyseOtmEqQ1h5BVSmOGV+yoEboNm2FDZH/gD9ZZ7kTi+bk4bvHRZSD06JiDZ12W/JGsmU77phVIIWuUcXghEZf/WRjTe4="
    # The next declaration is the encrypted COVERITY_SCAN_TOKEN, created
    # via the "travis encrypt" command using the project repo's public key
    - secure:  "4rmDT/vKTSi8AqI3afVUylayJ+SQbxblwlz/z81No4nLYWoy0dT61R/ZXq2Y29BE/HGEwx6r8Fl5RU6DxnmD7KhLC/3swHifzed690VDWyLii7cK8QkXVfLVVo8p+ozIwUrirnYFEkAcTfmkwJbmZN6DUuHJCl4x14NolR82VlJtFOVoWs63r+2NVJ5aM+63bkljkcW2U4xTt/8aOrCU/UapwqxC1GA0xPpwte6jPhzUjKXWbiknY+noUakM13x8SOkSRs3MTEf8J2va2T6DbVY3wy3x2Ytp4/KDwVNUrn/GKgBDRysP3jefO2d6XZJlb8OktJsrHdtWIZ+oYVwoy0PRV3vmdHs1NFUmYdQEe5UpiUKKyxWMsM+31to5ZUtJtn4kIlgzyo+xZu+LCgbOusJs33uPZODOON5fHcAoMp3AdAM0ResBfJdjzYEiewlcGYAcOoMX6DtopoJCoz+JxktdzXnjz89imNKMB2tjsRXuZMdE0WL3V2TSuOS5r8BwuuXXeul5vvE2EKHoIHgrP2nehz+q7dyC71m6jNrQX7x+xVg988vh0Fg8hyghLUzt9Myv4pvtQ/zQDbabKGtsakiHSvPTeHcb8mDhs62h5aIWUar8oXNuOWlk+hnyqZLmnbUPDcg54o567NursWYSWemAnPkPvSTfX0DQF1hDvSo="

addons:
  coverity_scan:
    project:
      name: "b23prodtm/myphpcms"
    notification_email: b23prodtm@users.sourceforge.net
    build_command_prepend: .travis/configure
    build_command: if [ '${PHPCS}' != '1' ]; then ./lib/Cake/Console/cake test core AllTests --stderr; else ./app/vendor/bin/phpcs -p --extensions=php --standard=CakePHP ./lib/Cake; fi;
    branch_pattern: development
services:
  - memcached

language: generic

matrix:
  fast_finish: true

  include:
    - os: linux
      php: 5.6
      env: DB=pgsql

    - os: linux
      php: 5.6
      env: DB=sqlite

    - os: linux
      php: 5.6

    - os: linux
      php: 7.0

    - os: linux
      php: 'nightly'

    - os: linux
      php: 'hhvm'

    - os: osx
      env: _PHP=php@5.6

    - os: osx
      env: _PHP=php@7.0

    - os: osx
      env: _PHP=php@7.1

  allow_failures:
    - php: 'nightly'
      php: 'hhvm'

before_install:
  - if [[ "${TRAVIS_OS_NAME}" == "linux" && "${TRAVIS_PHP_VERSION}" == 7* ]]; then COLLECT_COVERAGE=true ; fi
  - if [[ "${COLLECT_COVERAGE}" != "true" ]]; then phpenv config-rm xdebug.ini || true ; fi
  - if [[ "${TRAVIS_OS_NAME}" == "osx" ]]; then /usr/bin/env bash .travis/TravisCI-OSX-PHP/build/prepare_osx_env.sh ; fi
  # Coverity Scan certificate (global secure: COVERITY_SCAN_TOKEN)
  - echo -n | openssl s_client -connect https://scan.coverity.com:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-
  - ./Scripts/configure_tmp.sh

install:
  - if [[ "${TRAVIS_OS_NAME}" == "osx" ]]; then /usr/bin/env bash .travis/TravisCI-OSX-PHP/build/handle_brew_pkg.sh "${_PHP}" ; fi

# Local Test (osx configuration and mysql engine) :
# $ ./test-cake.sh --travis
before_script:
  - .travis/configure

script:
  - ./test-cake.sh

after_script:
  - if [[ "$COLLECT_COVERAGE" == "true" ]]; then travis_retry php app/vendor/bin/php-coveralls -v ; fi

# Openshift webhook notifies that a new build version is available
# $OC_SECRET is obtained from an Openshift Console and set secret environment variable
notifications:
  email: false
  webhooks:
    urls:
      - http://api.starter-us-west-1.openshift.com:443/oapi/v1/namespaces/e14/buildconfigs/cakephp-mysql-persistent/webhooks/$OC_SECRET/generic
      - https://webhook-proxy-e14.a3c1.starter-us-west-1.openshiftapps.com/travis-ci/api.starter-us-west-1.openshift.com:443/e14/cakephp-mysql-persistent/webhooks/$OC_SECRET/generic
    on_success: always
    on_failure: never
    on_start: never # default: always
